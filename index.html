<!DOCTYPE html>
<html lang="nl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Roostermeldingen</title>
    <link rel="manifest" href="manifest.json">
    <link rel="stylesheet" href="style.css">
    
    <script src="https://identity.netlify.com/v1/netlify-identity-widget.js"></script>
    <script src="https://cdn.onesignal.com/sdks/web/v16/OneSignalSDK.page.js" defer></script>
</head>
<body>

    <div id="auth-section" class="card">
        <h1>ğŸ” Beveiligde App</h1>
        <p>Log in met je account. Nieuwe gebruikers moeten eerst worden goedgekeurd door de beheerder.</p>
        <button onclick="netlifyIdentity.open()" class="btn-primary">Inloggen / Registreren</button>
    </div>

    <div id="install-instructions" class="card hidden">
        <h1>ğŸ“² Installeer de App</h1>
        <p>Voeg deze app toe aan je startscherm om meldingen te kunnen ontvangen.</p>
        <div id="ios-instructions" class="hidden">
            <p>Tik onderaan op het <strong>delen-icoon</strong> en kies <strong>'Zet op beginscherm'</strong>.</p>
        </div>
    </div>

    <div id="permission-section" class="card hidden">
        <h1>ğŸ”” Meldingen</h1>
        <p>Je bent ingelogd! Zet nu je meldingen aan om updates te ontvangen.</p>
        <button id="enable-btn" class="btn-primary">Meld je aan voor meldingen</button>
    </div>

    <div id="homepage" class="hidden">
        <div class="card">
            <div class="header-flex">
                <h2 id="welcome-text" style="margin:0;">ğŸ‘‹ Welkom</h2>
                <button onclick="logout()" class="btn-logout">Uitloggen</button>
            </div>
        </div>

        <div class="card">
            <h2>ğŸ“œ Geschiedenis</h2>
            <p id="no-msg">Geen berichten gevonden.</p>
            <ul id="history-list"></ul>
            <button onclick="clearHistory()" class="btn-danger">Wissen</button>
        </div>
    </div>

    <script>
        const ONESIGNAL_APP_ID = "34b6e89d-0d33-405e-8ee4-76ef90fa699a";

        // --- AUTH INITIALISATIE ---
        netlifyIdentity.on('init', user => {
            if (!user) {
                showSection('auth-section');
            } else {
                checkAccess(user);
            }
        });

        netlifyIdentity.on('login', user => {
            netlifyIdentity.close();
            checkAccess(user);
        });

        function logout() {
            netlifyIdentity.logout();
            location.reload();
        }

        // --- FLOW CONTROLE ---
        function checkAccess(user) {
            document.getElementById('welcome-text').innerText = `ğŸ‘‹ ${user.user_metadata.full_name || 'Gebruiker'}`;
            
            // Controleer of de app op het startscherm staat (PWA mode)
            const isStandalone = window.matchMedia('(display-mode: standalone)').matches || window.navigator.standalone === true;
            
            if (!isStandalone) {
                showSection('install-instructions');
                if (/iPad|iPhone|iPod/.test(navigator.userAgent)) {
                    document.getElementById('ios-instructions').classList.remove('hidden');
                }
            } else {
                initOneSignal();
            }
        }

        // --- ONESIGNAL MET GEHEUGEN ---
        function initOneSignal() {
            window.OneSignalDeferred = window.OneSignalDeferred || [];
            OneSignalDeferred.push(async function(OneSignal) {
                await OneSignal.init({ appId: ONESIGNAL_APP_ID });

                // Check of de browser al toestemming heeft OF OneSignal al geabonneerd is
                const isOptedIn = OneSignal.User.PushSubscription.optedIn;
                const permission = Notification.permission;

                if (isOptedIn || permission === "granted") {
                    showSection('homepage');
                    loadFromDB();
                } else {
                    showSection('permission-section');
                }
            });
        }

        document.getElementById('enable-btn').addEventListener('click', () => {
            OneSignalDeferred.push(async (OneSignal) => {
                // Forceer de browser prompt
                await OneSignal.Slidedown.promptPush();
                
                // Controleer na 2 seconden of het gelukt is
                setTimeout(() => {
                    if (Notification.permission === "granted") {
                        showSection('homepage');
                        loadFromDB();
                    }
                }, 2000);
            });
        });

        function showSection(id) {
            ['auth-section', 'install-instructions', 'permission-section', 'homepage'].forEach(s => {
                document.getElementById(s).classList.add('hidden');
            });
            document.getElementById(id).classList.remove('hidden');
        }

        // --- DATABASE LOGICA ---
        function loadFromDB() {
            const request = indexedDB.open("NotificationHistory", 1);
            request.onupgradeneeded = (e) => {
                e.target.result.createObjectStore("messages", { keyPath: "id", autoIncrement: true });
            };
            request.onsuccess = (e) => {
                const db = e.target.result;
                const transaction = db.transaction("messages", "readonly");
                const store = transaction.objectStore("messages");
                const getAll = store.getAll();
                getAll.onsuccess = () => renderHistory(getAll.result.reverse());
            };
        }

        function renderHistory(history) {
            const list = document.getElementById('history-list');
            const noMsg = document.getElementById('no-msg');
            list.innerHTML = '';
            if (history.length > 0) {
                noMsg.style.display = 'none';
                history.forEach(item => {
                    let li = document.createElement('li');
                    li.className = 'notif-item';
                    li.innerHTML = `<strong>${item.title}</strong><br>${item.body}<span class="notif-time">${item.time}</span>`;
                    list.appendChild(li);
                });
            } else {
                noMsg.style.display = 'block';
            }
        }

        function clearHistory() {
            const request = indexedDB.open("NotificationHistory", 1);
            request.onsuccess = (e) => {
                const db = e.target.result;
                const transaction = db.transaction("messages", "readwrite");
                transaction.objectStore("messages").clear();
                renderHistory([]);
            };
        }
    </script>
</body>
</html>
